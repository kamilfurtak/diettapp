<div class="p-4 md:p-6 max-w-4xl mx-auto flex flex-col items-center justify-center h-full">
  <div class="w-full bg-gray-800 p-6 rounded-2xl shadow-sm text-center">
    @switch (status()) {
      @case ('idle') {
        <div class="flex flex-col items-center space-y-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-28 h-28 text-lime-400">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          <h2 class="text-2xl font-bold text-gray-100">Add to {{ category() }}</h2>
          <p class="text-gray-400">Add a meal to your log manually or pick from your favorites.</p>
          <div class="w-full space-y-3 pt-2">
            <button (click)="status.set('adding')" class="w-full bg-lime-400 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-lime-500 transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Add New Meal
            </button>
            <button (click)="status.set('picking')" class="w-full bg-gray-700 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.584a.563.563 0 01.321.988l-4.202 3.095a.563.563 0 00-.182.557l1.528 5.4a.562.562 0 01-.82.622l-4.673-3.352a.563.563 0 00-.652 0l-4.673 3.352a.562.562 0 01-.82-.622l1.528-5.4a.563.563 0 00-.182-.557l-4.202-3.095a.563.563 0 01.321-.988h5.584a.563.563 0 00.475-.345L11.48 3.5z" />
              </svg>
              Pick from Favorites
            </button>
          </div>
        </div>
      }
      @case('picking') {
        <div class="space-y-4 text-left">
          <h2 class="text-2xl font-bold text-gray-100 text-center">Pick a Favorite Meal</h2>
          <div class="space-y-3 max-h-60 overflow-y-auto no-scrollbar">
            @for (meal of favoriteMeals(); track meal.name) {
              <div (click)="addFavoriteMeal(meal)" class="bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600">
                <div class="flex justify-between items-center">
                  <p class="font-semibold capitalize text-gray-100">{{ meal.name }}</p>
                  <p class="font-bold text-lime-400">{{ meal.calories }} kcal</p>
                </div>
                <p class="text-sm text-gray-400">
                  {{ meal.protein }}g P / {{ meal.carbs }}g C / {{ meal.fat }}g F
                </p>
              </div>
            }
            @if (favoriteMeals().length === 0) {
              <p class="text-center text-gray-400 py-4">You don't have any favorite meals yet.</p>
            }
          </div>
           <div class="flex gap-4">
            <button type="button" (click)="status.set('idle')" class="w-full bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
          </div>
        </div>
      }
      @case('adding') {
        <form [formGroup]="mealForm" (ngSubmit)="addMeal()" class="space-y-4 text-left">
          <h2 class="text-2xl font-bold text-gray-100 text-center">Add Meal to {{ category() }}</h2>
          <div>
            <label for="name" class="block text-sm font-medium text-gray-300">Name</label>
            <input type="text" id="name" formControlName="name" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-gray-100 focus:ring-lime-500 focus:border-lime-500">
          </div>
          <div>
            <label for="calories" class="block text-sm font-medium text-gray-300">Calories</label>
            <input type="number" id="calories" formControlName="calories" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-gray-100 focus:ring-lime-500 focus:border-lime-500">
          </div>
          <div>
            <label for="protein" class="block text-sm font-medium text-gray-300">Protein (g)</label>
            <input type="number" id="protein" formControlName="protein" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-gray-100 focus:ring-lime-500 focus:border-lime-500">
          </div>
          <div>
            <label for="carbs" class="block text-sm font-medium text-gray-300">Carbs (g)</label>
            <input type="number" id="carbs" formControlName="carbs" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-gray-100 focus:ring-lime-500 focus:border-lime-500">
          </div>
          <div>
            <label for="fat" class="block text-sm font-medium text-gray-300">Fat (g)</label>
            <input type="number" id="fat" formControlName="fat" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-gray-100 focus:ring-lime-500 focus:border-lime-500">
          </div>
          <div class="flex gap-4">
            <button type="button" (click)="status.set('idle')" class="w-full bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
            <button type="submit" [disabled]="mealForm.invalid" class="w-full bg-lime-400 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-lime-500 transition-colors disabled:opacity-50">Add Meal</button>
          </div>
        </form>
      }
      @case ('capturing') {
        <div class="relative w-full aspect-square md:aspect-video bg-black rounded-lg overflow-hidden">
          <video #video autoplay playsinline class="w-full h-full object-cover"></video>
          <button (click)="captureImage()" class="absolute bottom-4 left-1/2 -translate-x-1/2 w-16 h-16 bg-white rounded-full border-4 border-lime-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500"></button>
        </div>
        <canvas #canvas class="hidden"></canvas>
      }
      @case ('captured') {
        <div class="space-y-4">
          <h2 class="text-2xl font-bold text-gray-100">Confirm Photo</h2>
          <img [src]="imageDataUrl()" alt="Captured meal" class="w-full rounded-lg shadow-md aspect-square md:aspect-video object-cover" />
          <div class="grid grid-cols-2 gap-4">
            <button (click)="retake()" class="w-full bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors">Retake</button>
            <button (click)="analyze()" class="w-full bg-lime-400 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-lime-500 transition-colors">Analyze</button>
          </div>
        </div>
      }
      @case ('analyzing') {
        <div class="flex flex-col items-center space-y-4 py-10">
          <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-lime-500"></div>
          <h2 class="text-2xl font-bold text-gray-100">Analyzing...</h2>
          <p class="text-gray-400">Our AI is working its magic to identify your meal. Please wait a moment.</p>
        </div>
      }
      @case ('results') {
        <div class="space-y-4 text-left">
          <h2 class="text-2xl font-bold text-gray-100 text-center">Analysis Results</h2>
          <div class="space-y-3 max-h-60 overflow-y-auto no-scrollbar">
            @for (item of analysisResult(); track item.name) {
              <div class="bg-gray-700 p-3 rounded-lg">
                <div class="flex justify-between items-center">
                  <p class="font-semibold capitalize text-gray-100">{{ item.name }}</p>
                  <p class="font-bold text-lime-400">{{ item.calories }} kcal</p>
                </div>
                <p class="text-sm text-gray-400">
                  {{ item.protein }}g P / {{ item.carbs }}g C / {{ item.fat }}g F
                </p>
              </div>
            }
          </div>
          <button (click)="addMealsToLog()" class="w-full bg-lime-400 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-lime-500 transition-colors">
            Add to {{ category() }} Log
          </button>
        </div>
      }
      @case ('error') {
        <div class="flex flex-col items-center space-y-4 py-10">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-28 h-28 text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          <h2 class="text-2xl font-bold text-gray-100">An Error Occurred</h2>
          <p class="text-gray-400">{{ errorMessage() }}</p>wow
          <button (click)="retake()" class="mt-4 w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">
            Try Again
          </button>
        </div>
      }
    }
  </div>
</div>
